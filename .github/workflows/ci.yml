name: CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  standard:
    uses: c-daly/logos/.github/workflows/reusable-standard-ci.yml@main
    with:
      python_versions: '["3.11","3.12"]'
      python_package_manager: 'pip'
      python_install_command: 'python -m pip install --upgrade pip && pip install -r requirements-ci.txt && pip install -e .'
      python_requirements_path: 'requirements-ci.txt'
      python_command_prefix: ''
      python_lint_paths: 'src tests'
      mypy_targets: 'src'
      pytest_command: 'pytest --cov=hermes --cov-report=term --cov-report=xml'
      coverage_python_version: '3.12'
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  build:
    runs-on: ubuntu-latest
    needs: standard
    permissions:
      contents: read
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH
    - name: Cache Poetry dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pypoetry
        key: poetry-${{ hashFiles('poetry.lock') }}
    - name: Install dependencies
      run: poetry install --only main
    - name: Build package
      run: poetry build
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/

  integration-test:
    runs-on: ubuntu-latest
    needs: standard
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'integration-test')
    permissions:
      contents: read
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Start services
      run: |
        docker compose -f docker-compose.test.yml up -d milvus-etcd milvus-minio milvus

    - name: Wait for services
      run: |
        echo "Waiting for etcd..."
        timeout 60 bash -c 'until docker exec milvus-etcd etcdctl endpoint health 2>/dev/null; do sleep 2; done'
        
        echo "Waiting for MinIO..."
        timeout 60 bash -c 'until curl -f http://localhost:9000/minio/health/live 2>/dev/null; do sleep 2; done'
        
        echo "Waiting for Milvus..."
        timeout 120 bash -c 'until curl -f http://localhost:9091/healthz 2>/dev/null; do sleep 2; done'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-ci.txt
        pip install -e .
        pip install torch torchaudio --index-url https://download.pytorch.org/whl/cpu
        pip install sentence-transformers

    - name: Run integration tests
      env:
        MILVUS_HOST: localhost
        MILVUS_PORT: "19530"
      run: |
        pytest tests/hermes/test_milvus_integration.py -v --cov=hermes --cov-report=xml --cov-report=term

    - name: Upload integration test coverage
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: integration
        fail_ci_if_error: false
    
    - name: Stop services
      if: always()
      run: docker compose -f docker-compose.test.yml down -v
