name: CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run ML tests weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      run_ml_tests:
        description: 'Install ML dependencies and run full test suite'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  standard:
    uses: c-daly/logos/.github/workflows/reusable-standard-ci.yml@main
    with:
      python_versions: '["3.11","3.12"]'
      python_package_manager: 'poetry'
      python_command_prefix: 'poetry run '
      poetry_install_args: '-E dev'
      python_lint_paths: 'src tests'
      mypy_targets: 'src'
      # Start test services (Milvus, Neo4j) for full test coverage
      docker_compose_file: 'tests/e2e/stack/hermes/docker-compose.test.yml'
      docker_compose_wait_script: |
        # Port values from logos_config.HERMES_PORTS (hardcoded here since Python isn't available yet)
        echo "Waiting for etcd..."
        timeout 60 bash -c 'until docker exec hermes-test-milvus-etcd etcdctl endpoint health 2>/dev/null; do sleep 2; done'
        echo "Waiting for MinIO..."
        timeout 60 bash -c 'until curl -f http://localhost:17900/minio/health/live 2>/dev/null; do sleep 2; done'
        echo "Waiting for Milvus..."
        timeout 120 bash -c 'until curl -f http://localhost:17091/healthz 2>/dev/null; do sleep 2; done'
        echo "Waiting for Neo4j..."
        timeout 60 bash -c 'until curl -f http://localhost:17474 2>/dev/null; do sleep 2; done'
      pytest_env_script: |
        # Port values from logos_config.HERMES_PORTS
        export MILVUS_HOST=localhost
        export MILVUS_PORT=17530
        export NEO4J_URI=bolt://localhost:17687
        export NEO4J_USER=neo4j
        export NEO4J_PASSWORD=neo4jtest
      # -r s: show skip reasons, -r S: show skip summary
      # --cov-fail-under=60: Enforce 60% minimum coverage
      # Runs ALL tests with services available
      pytest_command: 'pytest tests/ --cov=hermes --cov-report=term --cov-report=xml --cov-fail-under=60 -r sS'
      coverage_python_version: '3.12'
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  build:
    runs-on: ubuntu-latest
    needs: standard
    permissions:
      contents: read
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH
    - name: Cache Poetry dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pypoetry
        key: poetry-${{ hashFiles('poetry.lock') }}
    - name: Install dependencies
      run: poetry install --only main
    - name: Build package
      run: poetry build
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/

  # Full ML test suite - weekly scheduled, manual dispatch, or 'ml-test' label
  ml-full-test:
    runs-on: ubuntu-latest
    needs: standard
    if: |
      github.event_name == 'schedule' ||
      github.event.inputs.run_ml_tests == 'true' ||
      contains(github.event.pull_request.labels.*.name, 'ml-test')
    permissions:
      contents: read
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Start services
      run: |
        docker compose -f tests/e2e/stack/hermes/docker-compose.test.yml up -d

    - name: Wait for services
      run: |
        echo "Waiting for etcd..."
        timeout 60 bash -c 'until docker exec hermes-test-milvus-etcd etcdctl endpoint health 2>/dev/null; do sleep 2; done'
        
        echo "Waiting for MinIO..."
        timeout 60 bash -c 'until curl -f http://localhost:9000/minio/health/live 2>/dev/null; do sleep 2; done'
        
        echo "Waiting for Milvus..."
        timeout 120 bash -c 'until curl -f http://localhost:18091/healthz 2>/dev/null; do sleep 2; done'
        
        echo "Waiting for Neo4j..."
        timeout 60 bash -c 'until curl -f http://localhost:18474 2>/dev/null; do sleep 2; done'

    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Install dependencies with ML extras
      run: |
        poetry install -E dev -E ml
        # Install CPU-only torch to save time/space
        poetry run pip install torch torchaudio --index-url https://download.pytorch.org/whl/cpu --force-reinstall

    - name: Run full test suite with ML
      env:
        MILVUS_HOST: localhost
        MILVUS_PORT: "18530"
        NEO4J_URI: bolt://localhost:18687
        NEO4J_USER: neo4j
        NEO4J_PASSWORD: neo4jtest
      run: |
        # Run ALL tests with ML dependencies installed
        # This should have minimal skips
        # --cov-fail-under=60: Enforce 60% minimum coverage
        poetry run pytest tests/ -v \
          --cov=hermes --cov-report=xml --cov-report=term --cov-fail-under=60 \
          -r sS \
          | tee pytest-output.txt
        
        # Extract and display test summary
        echo "::group::Test Summary"
        grep -E "(passed|failed|skipped|error)" pytest-output.txt | tail -5 || true
        echo "::endgroup::"

    - name: Upload ML test coverage
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: ml-full
        fail_ci_if_error: false

    - name: Upload coverage artifact
      uses: actions/upload-artifact@v4
      with:
        name: ml-full-coverage
        path: coverage.xml
    
    - name: Stop services
      if: always()
      run: docker compose -f tests/e2e/stack/hermes/docker-compose.test.yml down -v
