# Lightweight Dockerfile for Hermes API (without ML dependencies)
# Useful for development or when only API validation is needed
FROM python:3.11-slim

# Add metadata labels following OCI standards
LABEL org.opencontainers.image.title="Hermes API (Lightweight)" \
      org.opencontainers.image.description="Stateless language & embedding tools for Project LOGOS - Development build" \
      org.opencontainers.image.vendor="Project LOGOS Team" \
      org.opencontainers.image.source="https://github.com/c-daly/hermes" \
      org.opencontainers.image.licenses="MIT"

# Install minimal runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user for security
RUN useradd -m -u 1000 -s /bin/bash hermes && \
    mkdir -p /app && \
    chown -R hermes:hermes /app

# Set working directory
WORKDIR /app

# Copy dependency files
COPY --chown=hermes:hermes pyproject.toml .

# Install only core dependencies (no ML)
RUN pip install --no-cache-dir ".[dev]"

# Copy application source code
COPY --chown=hermes:hermes src/ src/

# Switch to non-root user for security
USER hermes

# Expose the API port
EXPOSE 8080

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app/src

# Add healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8080/ || exit 1

# Run the server as non-root user
CMD ["uvicorn", "hermes.main:app", "--host", "0.0.0.0", "--port", "8080"]
